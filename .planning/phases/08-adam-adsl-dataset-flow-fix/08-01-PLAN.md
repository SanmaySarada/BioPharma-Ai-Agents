---
phase: 08-adam-adsl-dataset-flow-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/omni_agents/models/schemas.py
  - src/omni_agents/pipeline/schema_validator.py
  - src/omni_agents/pipeline/data_dictionary.py
autonomous: true

must_haves:
  truths:
    - "ADSL.csv presence and column structure are validated by schema validator"
    - "ADaM data dictionary includes definitions for all ADSL variables"
    - "REQUIRED_ADSL_COLS constant exists and lists all required ADSL columns"
    - "validate_output_completeness() checks for adam/ADSL.csv existence"
  artifacts:
    - path: "src/omni_agents/models/schemas.py"
      provides: "REQUIRED_ADSL_COLS frozenset"
      contains: "REQUIRED_ADSL_COLS"
    - path: "src/omni_agents/pipeline/schema_validator.py"
      provides: "ADSL validation in validate_adam() AND ADSL.csv check in validate_output_completeness()"
      contains: "ADSL.csv"
    - path: "src/omni_agents/pipeline/data_dictionary.py"
      provides: "ADSL variable definitions in ADaM data dictionary"
      contains: "TRT01P"
  key_links:
    - from: "src/omni_agents/pipeline/schema_validator.py"
      to: "src/omni_agents/models/schemas.py"
      via: "import REQUIRED_ADSL_COLS"
      pattern: "from omni_agents.models.schemas import.*REQUIRED_ADSL_COLS"
---

<objective>
Add ADSL infrastructure: schema constants, schema validation, and data dictionary entries.

Purpose: Provide the validation and documentation layer for the new ADSL.csv dataset before the R code generation changes land. These are deterministic Python changes with no LLM involvement.
Output: REQUIRED_ADSL_COLS constant, ADSL validation in validate_adam(), ADSL.csv presence check in validate_output_completeness(), ADSL variable definitions in write_adam_data_dictionary()
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

@src/omni_agents/models/schemas.py
@src/omni_agents/pipeline/schema_validator.py
@src/omni_agents/pipeline/data_dictionary.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add REQUIRED_ADSL_COLS constant to schemas.py</name>
  <files>src/omni_agents/models/schemas.py</files>
  <action>
  Add a new `REQUIRED_ADSL_COLS` frozenset constant in the "ADaM Dataset Column Requirements" section, right after the existing `REQUIRED_ADTTE_COLS`. The ADSL columns required for this trial are:

  ```python
  REQUIRED_ADSL_COLS: frozenset[str] = frozenset({
      "STUDYID", "USUBJID", "SUBJID",
      "AGE", "AGEU", "AGEGR1", "SEX", "RACE",
      "ARM", "ARMCD", "TRT01P", "TRT01A",
      "SAFFL", "ITTFL", "EFFFL",
      "TRTSDT", "TRTEDT", "TRTDUR",
      "EOSSTT", "DCSREAS",
  })
  ```

  Also add an `ADSLSummary` Pydantic model (analogous to `ADTTESummary`) at the bottom of the file:

  ```python
  class ADSLSummary(BaseModel):
      """Summary of ADSL dataset for Python-side validation."""
      n_rows: int
      columns: list[str]
  ```

  This model will be used by schema_validator.py to parse the ADSL_summary.json produced by the R code.
  </action>
  <verify>Run `python -c "from omni_agents.models.schemas import REQUIRED_ADSL_COLS, ADSLSummary; print(len(REQUIRED_ADSL_COLS), 'cols'); print(ADSLSummary(n_rows=300, columns=['A']))"` successfully.</verify>
  <done>REQUIRED_ADSL_COLS contains exactly 20 ADSL column names. ADSLSummary model exists and validates.</done>
</task>

<task type="auto">
  <name>Task 2: Add ADSL validation to schema_validator.py (validate_adam AND validate_output_completeness) and ADSL entries to data_dictionary.py</name>
  <files>src/omni_agents/pipeline/schema_validator.py, src/omni_agents/pipeline/data_dictionary.py</files>
  <action>
  **schema_validator.py changes:**

  1. Add `REQUIRED_ADSL_COLS` and `ADSLSummary` to the imports from `omni_agents.models.schemas`.

  2. Update `validate_adam()` to ALSO check ADSL. Add these checks at the beginning (before ADTTE checks):
     - Check `ADSL.csv` exists in adam_dir
     - Check `ADSL_summary.json` exists in adam_dir
     - Parse ADSL_summary.json into ADSLSummary model
     - Check n_rows == expected_subjects (one row per subject)
     - Check all REQUIRED_ADSL_COLS are present in summary.columns
     - If ADSL checks fail, include issues but continue to also check ADTTE (collect all issues)

  3. Update the logger.info message at the end of validate_adam() to mention ADSL passing too.

  4. **CRITICAL (ADSL-09):** Update `validate_output_completeness()` to ALSO check for `adam/ADSL.csv` existence. Currently it only checks `sdtm/data_dictionary.csv` and `adam/data_dictionary.csv`. Add a check for `adam/ADSL.csv` AFTER the existing data dictionary checks:

     ```python
     adsl_csv = track_dir / "adam" / "ADSL.csv"
     if not adsl_csv.exists():
         issues.append(
             "adam/ADSL.csv not found â€” ADSL subject-level dataset missing"
         )
     ```

     Also update the success logger.info message to mention ADSL: `"Output completeness check passed: data dictionaries and ADSL present"`

  **data_dictionary.py changes:**

  5. Update `write_adam_data_dictionary()` to include ADSL variable definitions. Add these rows BEFORE the existing ADTTE rows. Use a comment separator `# ADSL variables` and `# ADTTE variables` for clarity. The ADSL variables to add:

  ```python
  # ADSL variables
  {"Variable": "STUDYID", "Label": "Study Identifier", "Type": "Char", "Derivation": "Fixed study identifier"},
  {"Variable": "USUBJID", "Label": "Unique Subject Identifier", "Type": "Char", "Derivation": "From DM domain"},
  {"Variable": "SUBJID", "Label": "Subject Identifier for Study", "Type": "Char", "Derivation": "From DM domain"},
  {"Variable": "AGE", "Label": "Age at Baseline", "Type": "Num", "Derivation": "From DM domain"},
  {"Variable": "AGEU", "Label": "Age Units", "Type": "Char", "Derivation": 'Fixed: "YEARS"'},
  {"Variable": "AGEGR1", "Label": "Age Group 1", "Type": "Char", "Derivation": '"<65" if AGE < 65, ">=65" otherwise'},
  {"Variable": "SEX", "Label": "Sex", "Type": "Char", "Derivation": "From DM domain (M/F)"},
  {"Variable": "RACE", "Label": "Race", "Type": "Char", "Derivation": "From DM domain, CDISC controlled terminology"},
  {"Variable": "ARM", "Label": "Planned Treatment Arm", "Type": "Char", "Derivation": "From DM domain (Treatment/Placebo)"},
  {"Variable": "ARMCD", "Label": "Planned Arm Code", "Type": "Char", "Derivation": "From DM domain (TRT/PBO)"},
  {"Variable": "TRT01P", "Label": "Planned Treatment for Period 01", "Type": "Char", "Derivation": "Set equal to ARM (no crossover in this study)"},
  {"Variable": "TRT01A", "Label": "Actual Treatment for Period 01", "Type": "Char", "Derivation": "Set equal to ARM (no crossover in this study)"},
  {"Variable": "SAFFL", "Label": "Safety Population Flag", "Type": "Char", "Derivation": '"Y" for all randomized subjects'},
  {"Variable": "ITTFL", "Label": "Intent-to-Treat Population Flag", "Type": "Char", "Derivation": '"Y" for all randomized subjects'},
  {"Variable": "EFFFL", "Label": "Efficacy Population Flag", "Type": "Char", "Derivation": '"Y" if subject has >= 1 post-baseline VS observation'},
  {"Variable": "TRTSDT", "Label": "Date of First Exposure to Treatment", "Type": "Num", "Derivation": "0 (baseline week)"},
  {"Variable": "TRTEDT", "Label": "Date of Last Exposure to Treatment", "Type": "Num", "Derivation": "Last observed visit number from VS (accounting for dropout)"},
  {"Variable": "TRTDUR", "Label": "Duration of Treatment (Weeks)", "Type": "Num", "Derivation": "TRTEDT - TRTSDT"},
  {"Variable": "EOSSTT", "Label": "End of Study Status", "Type": "Char", "Derivation": f'"COMPLETED" if last visit == {trial_config.visits - 1}, "DISCONTINUED" if dropped out'},
  {"Variable": "DCSREAS", "Label": "Reason for Discontinuation", "Type": "Char", "Derivation": 'Empty string if completed, "Dropout" if discontinued'},
  ```

  Note: The existing ADTTE rows in write_adam_data_dictionary() should remain as-is but update the AGE/SEX/ARM/ARMCD derivation text from "Carried from DM domain via left_join on USUBJID" to "Carried from ADSL via merge on USUBJID" (since ADTTE now derives from ADSL, not DM directly).
  </action>
  <verify>
  Run BOTH of these verification commands:

  1. Data dictionary verification:
  `python -c "from omni_agents.pipeline.data_dictionary import write_adam_data_dictionary; from omni_agents.config import TrialConfig; from pathlib import Path; import tempfile, csv; d = Path(tempfile.mkdtemp()); write_adam_data_dictionary(d, TrialConfig()); rows = list(csv.DictReader(open(d / 'data_dictionary.csv'))); vars = [r['Variable'] for r in rows]; print('TRT01P' in vars, 'SAFFL' in vars, 'EOSSTT' in vars, len(rows), 'rows')"`

  2. Schema validator ADSL validation verification (exercises validate_adam with ADSL files):
  `python -c "
from omni_agents.pipeline.schema_validator import SchemaValidator
from omni_agents.models.schemas import REQUIRED_ADSL_COLS
from pathlib import Path
import tempfile, json, csv
d = Path(tempfile.mkdtemp())
# Create valid ADSL files
with open(d / 'ADSL.csv', 'w', newline='') as f:
    w = csv.DictWriter(f, fieldnames=sorted(REQUIRED_ADSL_COLS))
    w.writeheader()
    for i in range(300):
        w.writerow({c: f'val_{i}' for c in sorted(REQUIRED_ADSL_COLS)})
json.dump({'n_rows': 300, 'columns': sorted(REQUIRED_ADSL_COLS)}, open(d / 'ADSL_summary.json', 'w'))
# Create valid ADTTE files (minimal for validate_adam to pass)
import struct
(d / 'ADTTE.rds').write_bytes(b'placeholder')
json.dump({'n_rows': 300, 'n_events': 215, 'n_censored': 85, 'columns': ['STUDYID','USUBJID','PARAMCD','PARAM','AVAL','CNSR','STARTDT','EVNTDESC','AGE','SEX','ARM','ARMCD'], 'paramcd': 'TTESB120'}, open(d / 'ADTTE_summary.json', 'w'))
SchemaValidator.validate_adam(d, expected_subjects=300)
print('validate_adam passed with ADSL files')
  "`

  3. Output completeness ADSL check verification:
  `python -c "
from omni_agents.pipeline.schema_validator import SchemaValidator, SchemaValidationError
from pathlib import Path
import tempfile
d = Path(tempfile.mkdtemp())
track = d / 'track'
(track / 'sdtm').mkdir(parents=True)
(track / 'adam').mkdir(parents=True)
(track / 'sdtm' / 'data_dictionary.csv').write_text('h')
(track / 'adam' / 'data_dictionary.csv').write_text('h')
# Missing ADSL.csv should fail
try:
    SchemaValidator.validate_output_completeness(track)
    print('ERROR: should have raised')
except SchemaValidationError as e:
    assert 'ADSL.csv' in str(e.issues), f'Wrong error: {e.issues}'
    print('validate_output_completeness correctly catches missing ADSL.csv')
  "`
  </verify>
  <done>
  - validate_adam() checks ADSL.csv + ADSL_summary.json existence, row count, and column completeness
  - validate_output_completeness() checks adam/ADSL.csv existence (ADSL-09)
  - write_adam_data_dictionary() produces rows for all 20 ADSL variables plus existing ADTTE variables
  - ADTTE derivation text updated to reference ADSL instead of DM
  </done>
</task>

</tasks>

<verification>
- `python -c "from omni_agents.models.schemas import REQUIRED_ADSL_COLS; assert len(REQUIRED_ADSL_COLS) == 20"`
- `python -c "from omni_agents.pipeline.schema_validator import SchemaValidator"` imports cleanly
- `python -c "from omni_agents.pipeline.data_dictionary import write_adam_data_dictionary; from omni_agents.config import TrialConfig; from pathlib import Path; import tempfile, csv; d = Path(tempfile.mkdtemp()); write_adam_data_dictionary(d, TrialConfig()); rows = list(csv.DictReader(open(d / 'data_dictionary.csv'))); assert any(r['Variable'] == 'TRT01P' for r in rows); assert any(r['Variable'] == 'EFFFL' for r in rows); print('All checks passed')"`
- Verify validate_output_completeness rejects missing ADSL.csv (see Task 2 verify command 3)
</verification>

<success_criteria>
- REQUIRED_ADSL_COLS frozenset has 20 columns matching ADSL specification
- ADSLSummary Pydantic model exists with n_rows and columns fields
- validate_adam() checks ADSL.csv, ADSL_summary.json, row count, and column presence
- validate_output_completeness() checks adam/ADSL.csv existence (ADSL-09)
- write_adam_data_dictionary() includes all 20 ADSL variable definitions
- ADTTE variable derivations updated to reference ADSL instead of DM
</success_criteria>

<output>
After completion, create `.planning/phases/08-adam-adsl-dataset-flow-fix/08-01-SUMMARY.md`
</output>
