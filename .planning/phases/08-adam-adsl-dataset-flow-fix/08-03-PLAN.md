---
phase: 08-adam-adsl-dataset-flow-fix
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - tests/test_pipeline/test_schema_validator.py
  - tests/test_pipeline/test_data_dictionary.py
autonomous: true

must_haves:
  truths:
    - "Tests verify ADSL validation catches missing ADSL.csv"
    - "Tests verify ADSL validation catches missing/wrong columns"
    - "Tests verify ADaM data dictionary includes ADSL variables"
    - "Tests verify ADaM agent user prompt references ADSL output files"
    - "All existing tests still pass (no regressions)"
  artifacts:
    - path: "tests/test_pipeline/test_schema_validator.py"
      provides: "ADSL validation tests"
      contains: "adsl"
    - path: "tests/test_pipeline/test_data_dictionary.py"
      provides: "ADSL data dictionary variable tests"
      contains: "TRT01P"
  key_links:
    - from: "tests/test_pipeline/test_schema_validator.py"
      to: "src/omni_agents/pipeline/schema_validator.py"
      via: "import SchemaValidator"
      pattern: "SchemaValidator.validate_adam"
    - from: "tests/test_pipeline/test_data_dictionary.py"
      to: "src/omni_agents/pipeline/data_dictionary.py"
      via: "import write_adam_data_dictionary"
      pattern: "write_adam_data_dictionary"
---

<objective>
Add tests for ADSL validation, ADSL data dictionary entries, and updated ADaM agent prompt.

Purpose: Ensure the ADSL infrastructure (Plan 01) and R code generation changes (Plan 02) are properly tested. Verify no regressions in existing tests.
Output: New test functions in test_schema_validator.py and test_data_dictionary.py, all tests passing
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

@tests/test_pipeline/test_schema_validator.py
@tests/test_pipeline/test_data_dictionary.py
@tests/conftest.py
@src/omni_agents/models/schemas.py
@src/omni_agents/pipeline/schema_validator.py
@src/omni_agents/pipeline/data_dictionary.py
@src/omni_agents/agents/adam.py

# Prior plan summaries for context on what was built
@.planning/phases/08-adam-adsl-dataset-flow-fix/08-01-SUMMARY.md
@.planning/phases/08-adam-adsl-dataset-flow-fix/08-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ADSL schema validation tests</name>
  <files>tests/test_pipeline/test_schema_validator.py</files>
  <action>
  Update the existing `_make_adam_dir` helper to also create ADSL.csv and ADSL_summary.json, so existing ADTTE tests still pass with the updated validate_adam() that now also checks ADSL.

  1. Update `_make_adam_dir()` to accept an optional `include_adsl: bool = True` parameter. When True (default), also create:
     - A minimal ADSL.csv with header row containing all REQUIRED_ADSL_COLS columns and n_rows data rows (use csv.DictWriter with dummy data -- USUBJID as "SBP-001-SUBJ-{i}", AGE as 55, etc.)
     - ADSL_summary.json with `{"n_rows": n_rows, "columns": [list of all REQUIRED_ADSL_COLS]}`

     where `n_rows = n_events + n_censored` (same as ADTTE expected_subjects).

  2. Import `REQUIRED_ADSL_COLS` from `omni_agents.models.schemas` at the top.

  3. Add these new test functions:

  ```python
  def test_adam_missing_adsl_csv_fails(tmp_path: Path) -> None:
      """validate_adam fails when ADSL.csv is missing."""
      adam_dir = _make_adam_dir(tmp_path, n_events=215, n_censored=85, include_adsl=False)
      with pytest.raises(SchemaValidationError, match="ADSL.csv not found"):
          SchemaValidator.validate_adam(adam_dir, expected_subjects=300)

  def test_adam_missing_adsl_summary_fails(tmp_path: Path) -> None:
      """validate_adam fails when ADSL_summary.json is missing."""
      adam_dir = _make_adam_dir(tmp_path, n_events=215, n_censored=85)
      (adam_dir / "ADSL_summary.json").unlink()
      with pytest.raises(SchemaValidationError, match="ADSL_summary.json not found"):
          SchemaValidator.validate_adam(adam_dir, expected_subjects=300)

  def test_adam_adsl_wrong_row_count_fails(tmp_path: Path) -> None:
      """validate_adam fails when ADSL has wrong number of rows."""
      adam_dir = _make_adam_dir(tmp_path, n_events=215, n_censored=85)
      # Overwrite summary with wrong row count
      summary = {"n_rows": 200, "columns": sorted(REQUIRED_ADSL_COLS)}
      (adam_dir / "ADSL_summary.json").write_text(json.dumps(summary))
      with pytest.raises(SchemaValidationError, match="ADSL.*expected 300.*got 200"):
          SchemaValidator.validate_adam(adam_dir, expected_subjects=300)

  def test_adam_adsl_missing_columns_fails(tmp_path: Path) -> None:
      """validate_adam fails when ADSL is missing required columns."""
      adam_dir = _make_adam_dir(tmp_path, n_events=215, n_censored=85)
      # Overwrite summary with missing columns
      incomplete_cols = sorted(REQUIRED_ADSL_COLS - {"TRT01P", "SAFFL"})
      summary = {"n_rows": 300, "columns": incomplete_cols}
      (adam_dir / "ADSL_summary.json").write_text(json.dumps(summary))
      with pytest.raises(SchemaValidationError, match="ADSL.*missing required columns"):
          SchemaValidator.validate_adam(adam_dir, expected_subjects=300)

  def test_adam_with_adsl_passes(tmp_path: Path) -> None:
      """validate_adam passes when both ADSL and ADTTE are valid."""
      adam_dir = _make_adam_dir(tmp_path, n_events=215, n_censored=85)
      # Should not raise
      SchemaValidator.validate_adam(adam_dir, expected_subjects=300)
  ```

  4. Verify that existing tests (`test_adam_zero_censored_fails`, `test_adam_high_event_rate_fails`, `test_adam_normal_event_rate_passes`) still pass by ensuring `_make_adam_dir` creates ADSL files by default.
  </action>
  <verify>Run `python -m pytest tests/test_pipeline/test_schema_validator.py -v` -- all tests pass including new ADSL tests.</verify>
  <done>5 new ADSL validation tests pass. 3 existing ADTTE tests still pass. 4 existing output completeness tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add ADSL data dictionary tests and verify agent prompt</name>
  <files>tests/test_pipeline/test_data_dictionary.py</files>
  <action>
  Add tests to verify ADSL variables are included in the ADaM data dictionary.

  1. Add new test functions:

  ```python
  def test_adam_data_dictionary_contains_adsl_variables(tmp_path: Path) -> None:
      """ADaM data dictionary contains ADSL population flags and treatment vars."""
      write_adam_data_dictionary(tmp_path, TrialConfig())
      with open(tmp_path / "data_dictionary.csv") as f:
          reader = csv.DictReader(f)
          rows = list(reader)
      variables = [row["Variable"] for row in rows]
      for var in (
          "TRT01P", "TRT01A", "SAFFL", "ITTFL", "EFFFL",
          "TRTSDT", "TRTEDT", "TRTDUR", "EOSSTT", "DCSREAS",
          "AGEGR1", "AGEU",
      ):
          assert var in variables, f"Missing ADSL variable: {var}"

  def test_adam_data_dictionary_adtte_derivation_references_adsl(tmp_path: Path) -> None:
      """ADTTE variable derivations reference ADSL, not DM directly."""
      write_adam_data_dictionary(tmp_path, TrialConfig())
      with open(tmp_path / "data_dictionary.csv") as f:
          reader = csv.DictReader(f)
          rows = list(reader)
      # Find ADTTE AGE derivation (the one that should say "from ADSL")
      # There are two AGE rows: one for ADSL (from DM) and one for ADTTE (from ADSL)
      # The ADTTE one should reference ADSL
      adtte_vars_from_adsl = []
      seen_adtte_section = False
      for row in rows:
          if row["Variable"] == "PARAMCD":
              seen_adtte_section = True
          if seen_adtte_section and row["Variable"] in ("AGE", "SEX", "ARM", "ARMCD"):
              adtte_vars_from_adsl.append(row)
      assert len(adtte_vars_from_adsl) >= 4, "Expected AGE, SEX, ARM, ARMCD in ADTTE section"
      for row in adtte_vars_from_adsl:
          assert "ADSL" in row["Derivation"], (
              f"ADTTE {row['Variable']} derivation should reference ADSL, "
              f"got: {row['Derivation']}"
          )
  ```

  2. Update the existing `test_adam_data_dictionary_contains_adtte_variables` test if needed -- it checks for ADTTE variables which should still be present. It should continue to pass.

  3. Run the full test suite to confirm no regressions:
     `python -m pytest tests/ -v`
  </action>
  <verify>Run `python -m pytest tests/test_pipeline/test_data_dictionary.py tests/test_pipeline/test_schema_validator.py -v` -- all tests pass.</verify>
  <done>
  - ADSL variable tests confirm all 12 new ADSL-specific variables are in data dictionary
  - ADTTE derivation test confirms AGE/SEX/ARM/ARMCD reference ADSL
  - All existing tests pass (no regressions)
  - Full test suite passes: `python -m pytest tests/ -v`
  </done>
</task>

</tasks>

<verification>
- `python -m pytest tests/test_pipeline/test_schema_validator.py -v` -- all pass (12 tests)
- `python -m pytest tests/test_pipeline/test_data_dictionary.py -v` -- all pass (11 tests)
- `python -m pytest tests/ -v` -- full suite passes, no regressions
</verification>

<success_criteria>
- 5 new ADSL schema validation tests pass
- 2 new ADSL data dictionary tests pass
- All existing tests pass unchanged (no regressions)
- Full test suite green
</success_criteria>

<output>
After completion, create `.planning/phases/08-adam-adsl-dataset-flow-fix/08-03-SUMMARY.md`
</output>
