---
phase: 08-adam-adsl-dataset-flow-fix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/omni_agents/templates/prompts/adam.j2
  - src/omni_agents/agents/adam.py
  - src/omni_agents/pipeline/orchestrator.py
autonomous: true

must_haves:
  truths:
    - "ADaM R code generates ADSL.csv first, then derives ADTTE from ADSL instead of DM"
    - "ADSL.csv has one row per subject with demographics, treatment vars, population flags, and disposition"
    - "ADTTE joins subject-level variables from ADSL, not directly from SDTM DM"
    - "Pipeline orchestrator expects ADSL.csv and ADSL_summary.json as ADaM outputs"
  artifacts:
    - path: "src/omni_agents/templates/prompts/adam.j2"
      provides: "Combined ADSL + ADTTE R code generation instructions"
      contains: "ADSL"
    - path: "src/omni_agents/agents/adam.py"
      provides: "Updated user prompt mentioning ADSL.csv output"
      contains: "ADSL"
    - path: "src/omni_agents/pipeline/orchestrator.py"
      provides: "Updated expected_outputs including ADSL.csv"
      contains: "ADSL"
  key_links:
    - from: "src/omni_agents/templates/prompts/adam.j2"
      to: "R code output"
      via: "Jinja2 template rendered as system prompt"
      pattern: "ADSL\\.csv"
    - from: "src/omni_agents/agents/adam.py"
      to: "src/omni_agents/templates/prompts/adam.j2"
      via: "prompt_template_name property"
      pattern: "adam\\.j2"
    - from: "src/omni_agents/pipeline/orchestrator.py"
      to: "src/omni_agents/agents/adam.py"
      via: "ADaMAgent instantiation and _run_agent call"
      pattern: "expected_outputs.*ADSL"
---

<objective>
Update the ADaM prompt template, agent, and orchestrator to generate ADSL.csv alongside ADTTE.

Purpose: This is the core change -- making the LLM-generated R code produce an ADSL subject-level dataset first, then derive ADTTE from ADSL (not from DM directly). This satisfies ADSL-01 through ADSL-07.
Output: Updated adam.j2 with ADSL + ADTTE instructions, updated adam.py user prompt, updated orchestrator expected outputs
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

@src/omni_agents/templates/prompts/adam.j2
@src/omni_agents/agents/adam.py
@src/omni_agents/pipeline/orchestrator.py
@src/omni_agents/agents/stats.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite adam.j2 to generate ADSL + ADTTE</name>
  <files>src/omni_agents/templates/prompts/adam.j2</files>
  <action>
  Rewrite the adam.j2 Jinja2 prompt template to instruct the LLM to generate R code that produces BOTH ADSL.csv and ADTTE (from ADSL). The template must be a complete replacement of the current file.

  **Structure of the new template:**

  1. **Role preamble**: "You are an R programmer specializing in CDISC ADaM dataset construction. Generate R code to create ADSL (Subject-Level Analysis Dataset) and ADTTE (Analysis Dataset for Time-to-Event) from SDTM DM and VS domains."

  2. **Available R Packages** section: Keep identical to current (tidyverse, jsonlite only).

  3. **Input Data** section: Keep identical to current (DM.csv and VS.csv descriptions with `{{ n_subjects }}` and `{{ visits }}`).

  4. **NEW: Part 1 -- ADSL Dataset** section. Explain ADSL construction.

     **ADSL must be created FIRST, before ADTTE.** Include an explicit ADSL column reference table (like the existing ADTTE table) so the LLM has an unambiguous list of the exact 20 column names and their derivations. The table must be:

     ```
     ## ADSL Output Specification

     The output ADSL dataset must contain exactly these columns:

     | Column   | Type | Value                                                                                |
     |----------|------|--------------------------------------------------------------------------------------|
     | STUDYID  | Char | "{{ study_id }}"                                                                     |
     | USUBJID  | Char | From DM.USUBJID                                                                      |
     | SUBJID   | Char | From DM.SUBJID                                                                       |
     | AGE      | Num  | From DM.AGE                                                                          |
     | AGEU     | Char | "YEARS"                                                                              |
     | AGEGR1   | Char | "<65" if AGE < 65, ">=65" otherwise                                                  |
     | SEX      | Char | From DM.SEX                                                                          |
     | RACE     | Char | From DM.RACE                                                                         |
     | ARM      | Char | From DM.ARM                                                                          |
     | ARMCD    | Char | From DM.ARMCD                                                                        |
     | TRT01P   | Char | = ARM (no crossover in this study)                                                   |
     | TRT01A   | Char | = ARM (no crossover in this study)                                                   |
     | SAFFL    | Char | "Y" for all randomized subjects                                                     |
     | ITTFL    | Char | "Y" for all randomized subjects                                                     |
     | EFFFL    | Char | "Y" if subject has >= 1 post-baseline VS observation with non-NA VSSTRESN            |
     | TRTSDT   | Num  | 0 (baseline week)                                                                    |
     | TRTEDT   | Num  | Last observed (non-NA) VISITNUM for the subject from VS                              |
     | TRTDUR   | Num  | TRTEDT - TRTSDT                                                                      |
     | EOSSTT   | Char | "COMPLETED" if TRTEDT == {{ visits - 1 }}, "DISCONTINUED" otherwise                 |
     | DCSREAS  | Char | "" if EOSSTT == "COMPLETED", "Dropout" if EOSSTT == "DISCONTINUED"                   |
     ```

     After the table, add the detailed derivation notes:

     a. Read DM.csv and VS.csv
     b. Create ADSL with one row per subject. Key derivation details:
        - `TRTEDT`: Use `max(VISITNUM[!is.na(VSSTRESN)])` per subject. IMPORTANT: Handle with `na.rm = TRUE` AND check for empty vector -- `max(integer(0), na.rm=TRUE)` returns `-Inf`. Subjects with all NA should get TRTEDT = 0.
        - `EFFFL`: "Y" if the subject has at least 1 post-baseline (VISITNUM > 0) VS observation where VSSTRESN is non-NA
        - `EOSSTT`/`DCSREAS`: Based on TRTEDT comparison to {{ visits - 1 }}

     c. Save ADSL as CSV: `write.csv(adsl, "<output_path>/ADSL.csv", row.names = FALSE)`
     d. Write ADSL summary JSON for Python validation:
        ```r
        adsl_summary <- list(
          n_rows = nrow(adsl),
          columns = names(adsl)
        )
        write_json(adsl_summary, "<output_path>/ADSL_summary.json", auto_unbox = TRUE)
        ```
     e. Print ADSL summary to stdout

  5. **Part 2 -- ADTTE Dataset** section. KEEP the existing ADTTE spec but with ONE KEY CHANGE: instead of joining demographics from DM.csv, ADTTE must merge subject-level variables from the ADSL dataframe already in memory. Specifically:

     - The existing ADTTE output spec (columns, values) stays the same
     - But AGE, SEX, ARM, ARMCD come from `adsl` (already in R session) via `left_join(adsl %>% select(USUBJID, AGE, SEX, ARM, ARMCD), by = "USUBJID")` instead of from `dm`
     - The event detection logic still reads VS.csv directly (it needs per-visit data)
     - ADTTE.rds and ADTTE_summary.json output specs remain identical to current

  6. **Critical Rules** section: Keep ALL existing rules (CNSR convention, NA handling, dropout detection, AVAL units, one row per subject, dual output, Inf from aggregation) and add:
     - Rule 8: **ADSL FIRST**: ADSL.csv must be written to disk BEFORE ADTTE construction begins. The R script must create and save ADSL, then use the ADSL dataframe (not DM) for ADTTE subject-level variables.
     - Rule 9: **FOUR OUTPUTS**: The R script must produce exactly four files: ADSL.csv, ADSL_summary.json, ADTTE.rds, ADTTE_summary.json. All four are required for pipeline validation.

  7. **Important Notes** section: Keep identical to current.

  **Template variables used:** `{{ n_subjects }}`, `{{ visits }}`, `{{ study_id }}`, `{{ event_threshold }}` -- same as current.

  **IMPORTANT:** The ADTTE column spec table MUST remain identical to the current one (STUDYID, USUBJID, PARAMCD, PARAM, AVAL, CNSR, STARTDT, EVNTDESC, AGE, SEX, ARM, ARMCD). The only change is WHERE AGE/SEX/ARM/ARMCD come from (ADSL instead of DM).
  </action>
  <verify>
  Run `python -c "
from jinja2 import Environment, FileSystemLoader
env = Environment(loader=FileSystemLoader('src/omni_agents/templates/prompts'))
t = env.get_template('adam.j2')
rendered = t.render(n_subjects=300, visits=26, study_id='SBP-001', event_threshold=120)
assert 'ADSL' in rendered
assert 'ADSL.csv' in rendered
assert 'ADSL_summary.json' in rendered
assert 'TRT01P' in rendered
assert 'SAFFL' in rendered
assert 'EOSSTT' in rendered
assert 'ADTTE.rds' in rendered
assert 'ADTTE_summary.json' in rendered
assert 'CNSR' in rendered
assert 'is.finite' in rendered or 'Inf' in rendered
# Verify ADSL column table exists (check for table-formatted column names)
assert '| STUDYID' in rendered
assert '| TRTEDT' in rendered
assert '| DCSREAS' in rendered
assert '| TRT01A' in rendered
print('Template renders correctly with all required content including ADSL column table')
  "` from the project root.
  </verify>
  <done>adam.j2 instructs LLM to generate R code that creates ADSL.csv first (with all 20 columns listed in an explicit column table), then ADTTE from ADSL (not DM), producing 4 output files total.</done>
</task>

<task type="auto">
  <name>Task 2: Update adam.py user prompt and orchestrator.py expected outputs</name>
  <files>src/omni_agents/agents/adam.py, src/omni_agents/pipeline/orchestrator.py</files>
  <action>
  **adam.py changes:**

  1. Update the module docstring to mention ADSL: "constructs ADSL and ADTTE from SDTM domains"

  2. Update the class docstring: "Agent 3A: Constructs ADSL (Subject-Level) and ADTTE (Time-to-Event) datasets from SDTM domains."

  3. Update `build_user_prompt()`:

     For the initial call (no previous_error), change the return string to:
     ```python
     return (
         f"Generate R code to construct ADSL (Subject-Level Analysis Dataset) "
         f"and ADTTE (time-to-event) dataset from CDISC SDTM domains. "
         f"Read DM.csv from '{input_dir}/DM.csv' and VS.csv from '{input_dir}/VS.csv'. "
         f"Write ADSL.csv to '{output_dir}/ADSL.csv', "
         f"ADSL_summary.json to '{output_dir}/ADSL_summary.json', "
         f"ADTTE.rds to '{output_dir}/ADTTE.rds', and "
         f"ADTTE_summary.json to '{output_dir}/ADTTE_summary.json'."
     )
     ```

     For the retry path (previous_error exists), update similarly:
     ```python
     return (
         f"Your previous R code produced an error. "
         f"This is attempt {context['attempt_number']}.\n\n"
         f"Error output:\n```\n{context['previous_error']}\n```\n\n"
         f"Fix the R code. Read DM.csv from '{input_dir}/DM.csv' and "
         f"VS.csv from '{input_dir}/VS.csv'. "
         f"Write ADSL.csv to '{output_dir}/ADSL.csv', "
         f"ADSL_summary.json to '{output_dir}/ADSL_summary.json', "
         f"ADTTE.rds to '{output_dir}/ADTTE.rds', and "
         f"ADTTE_summary.json to '{output_dir}/ADTTE_summary.json'."
     )
     ```

  **orchestrator.py changes:**

  4. In `_run_track()`, update the ADaM agent section's `expected_outputs` list to include ADSL files:
     Change `expected_outputs=["ADTTE.rds", "ADTTE_summary.json"]`
     to `expected_outputs=["ADSL.csv", "ADSL_summary.json", "ADTTE.rds", "ADTTE_summary.json"]`

  5. No changes needed to Stats agent section -- Stats reads ADTTE.rds (which still exists in adam_dir) and DM.csv/VS.csv from sdtm_dir. The Stats agent does NOT need to read ADSL.csv because it uses ADTTE for survival analysis and reads DM/VS directly for Table 1 demographics. This is correct -- Table 1 uses raw SDTM data, not derived ADaM data.

  **Do NOT change:**
  - The Stats agent's input_volumes or expected_inputs (it reads ADTTE.rds, DM.csv, VS.csv)
  - The validate_adam() call location (Plan 01 handles adding ADSL checks there)
  - The data dictionary calls (Plan 01 handles those)
  </action>
  <verify>
  Run `python -c "
from omni_agents.agents.adam import ADaMAgent
from unittest.mock import MagicMock
agent = ADaMAgent(llm=MagicMock(), prompt_dir=MagicMock(), trial_config=MagicMock())
prompt = agent.build_user_prompt({'input_dir': '/workspace/input', 'output_dir': '/workspace'})
assert 'ADSL.csv' in prompt
assert 'ADSL_summary.json' in prompt
assert 'ADTTE.rds' in prompt
assert 'ADTTE_summary.json' in prompt
print('User prompt includes all 4 output files')
  "` from the project root.

  Also verify orchestrator imports cleanly:
  `python -c "from omni_agents.pipeline.orchestrator import PipelineOrchestrator; print('Import OK')"`
  </verify>
  <done>
  - adam.py user prompt mentions all 4 output files (ADSL.csv, ADSL_summary.json, ADTTE.rds, ADTTE_summary.json)
  - adam.py docstrings reference ADSL
  - orchestrator.py expected_outputs for ADaM agent includes ADSL.csv and ADSL_summary.json
  </done>
</task>

</tasks>

<verification>
- adam.j2 renders with ADSL construction instructions, ADSL column table, population flags, disposition, treatment timing
- adam.py build_user_prompt() references all 4 output files
- orchestrator.py ADaM expected_outputs includes ADSL files
- All modules import cleanly: `python -c "from omni_agents.pipeline.orchestrator import PipelineOrchestrator"`
</verification>

<success_criteria>
- adam.j2 instructs R code generation for ADSL first, then ADTTE from ADSL
- ADSL spec includes explicit column table with all 20 variables (demographics, treatment, population flags, disposition, timing)
- ADTTE spec unchanged except AGE/SEX/ARM/ARMCD sourced from ADSL instead of DM
- adam.py mentions all 4 output files in both initial and retry prompts
- orchestrator.py expects ADSL.csv and ADSL_summary.json from ADaM agent
</success_criteria>

<output>
After completion, create `.planning/phases/08-adam-adsl-dataset-flow-fix/08-02-SUMMARY.md`
</output>
