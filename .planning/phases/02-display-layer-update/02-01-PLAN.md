---
phase: 02-display-layer-update
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/omni_agents/display/pipeline_display.py
  - config.example.yaml
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All 9 pipeline steps (simulator, sdtm_track_a, sdtm_track_b, adam_track_a, adam_track_b, stats_track_a, stats_track_b, stage_comparison, medical_writer) appear in the terminal status table"
    - "Track A progress bar advances for sdtm_track_a, adam_track_a, stats_track_a completions"
    - "Track B progress bar advances for sdtm_track_b, adam_track_b, stats_track_b completions"
    - "Resolution start and completion events are displayed in both interactive and non-interactive modes"
    - "config.example.yaml documents the resolution section with enabled and max_iterations fields"
  artifacts:
    - path: "src/omni_agents/display/pipeline_display.py"
      provides: "Updated display with track-qualified steps + resolution callbacks"
      contains: "sdtm_track_a"
    - path: "config.example.yaml"
      provides: "Resolution config documentation"
      contains: "resolution:"
  key_links:
    - from: "src/omni_agents/pipeline/orchestrator.py"
      to: "src/omni_agents/display/pipeline_display.py"
      via: "callback step_name strings must match _STEPS list"
      pattern: "sdtm_track_a|adam_track_b|stage_comparison"
    - from: "src/omni_agents/pipeline/orchestrator.py"
      to: "src/omni_agents/display/pipeline_display.py"
      via: "on_resolution_start/on_resolution_complete callback methods"
      pattern: "on_resolution_(start|complete)"
---

<objective>
Close three tech debt items from v1-MILESTONE-AUDIT.md: update PipelineDisplay for track-qualified step names, implement resolution display callbacks, and document the resolution config section in config.example.yaml.

Purpose: The CLI terminal currently hides 6 of 10 pipeline steps and all resolution activity. Users see an incomplete picture of pipeline execution. Config resolution settings are undiscoverable.
Output: Fully updated pipeline_display.py + config.example.yaml.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v1-MILESTONE-AUDIT.md
@src/omni_agents/display/pipeline_display.py
@src/omni_agents/display/callbacks.py
@config.example.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update _STEPS and progress bars for track-qualified step names</name>
  <files>src/omni_agents/display/pipeline_display.py</files>
  <action>
Replace the stale `_STEPS`, `_TRACK_A_STEPS`, and `_TRACK_B_STEPS` module-level lists with the actual step names emitted by the orchestrator:

```python
_STEPS = [
    "simulator",
    "sdtm_track_a",
    "sdtm_track_b",
    "adam_track_a",
    "adam_track_b",
    "stats_track_a",
    "stats_track_b",
    "stage_comparison",
    "medical_writer",
]

_TRACK_A_STEPS = {"sdtm_track_a", "adam_track_a", "stats_track_a"}
_TRACK_B_STEPS = {"sdtm_track_b", "adam_track_b", "stats_track_b"}
```

Update `_build_table` docstring from "seven" to "nine" pipeline steps.
Update class docstring from "seven" to "nine" pipeline steps.

Update `start()` method: change Track B progress bar total from 1 to 3 (`self._progress.add_task("Track B", total=3)`) since Track B now runs all 3 stages.

Do NOT change the callback method signatures or the `ProgressCallback` protocol.
Do NOT change `_build_renderable`, `_build_progress`, `start`, `stop`, or any other methods besides what is specified.
  </action>
  <verify>
Run: `python -c "from omni_agents.display.pipeline_display import _STEPS, _TRACK_A_STEPS, _TRACK_B_STEPS; assert len(_STEPS) == 9; assert 'sdtm_track_a' in _STEPS; assert 'double_programmer' not in _STEPS; assert len(_TRACK_A_STEPS) == 3; assert len(_TRACK_B_STEPS) == 3; print('PASS')"`
  </verify>
  <done>_STEPS contains all 9 orchestrator step names, _TRACK_A_STEPS and _TRACK_B_STEPS each contain the 3 track-qualified names, Track B progress bar total is 3.</done>
</task>

<task type="auto">
  <name>Task 2: Implement on_resolution_start and on_resolution_complete</name>
  <files>src/omni_agents/display/pipeline_display.py</files>
  <action>
Add two new methods to PipelineDisplay that implement the resolution callbacks from the ProgressCallback protocol. Place them in the "ProgressCallback implementation" section, after `on_pipeline_fail`.

```python
def on_resolution_start(
    self, stage: str, iteration: int, max_iterations: int
) -> None:
    if not self._interactive:
        self.console.print(
            f"[resolution] Resolving {stage} disagreement "
            f"(iteration {iteration}/{max_iterations})"
        )

def on_resolution_complete(
    self, stage: str, resolved: bool, iterations: int
) -> None:
    status = "resolved" if resolved else "unresolved"
    if not self._interactive:
        self.console.print(
            f"[resolution] {stage} {status} after {iterations} iteration(s)"
        )
```

For interactive mode, the resolution activity is implicitly visible through the step retry/re-run callbacks that fire during resolution (the _run_track re-invocations emit on_step_start/on_step_complete for the retried stages). The non-interactive fallback needs explicit resolution log lines since those users cannot see the Live table updating.

Do NOT modify the ProgressCallback protocol in callbacks.py -- these methods are already declared there.
Do NOT add resolution as a row in the _STEPS table -- resolution is a meta-activity, not a pipeline step.
  </action>
  <verify>
Run: `python -c "from omni_agents.display.pipeline_display import PipelineDisplay; d = PipelineDisplay(); d.on_resolution_start('sdtm', 1, 2); d.on_resolution_complete('sdtm', True, 1); print('PASS')"`
  </verify>
  <done>PipelineDisplay implements on_resolution_start and on_resolution_complete. Non-interactive mode prints resolution status lines. Methods match the ProgressCallback protocol signatures exactly.</done>
</task>

<task type="auto">
  <name>Task 3: Document resolution config in config.example.yaml</name>
  <files>config.example.yaml</files>
  <action>
Add a `resolution:` section to config.example.yaml between the `llm:` section and the `output_dir:` line. Include both fields with their defaults and explanatory comments:

```yaml
resolution:
  # Whether to attempt automated resolution when tracks disagree.
  # Set to false to halt immediately on any stage disagreement.
  enabled: true
  # Maximum resolution iterations before halting or picking best track.
  max_iterations: 2
```

Keep the existing blank line before `output_dir`. The section should clearly explain what each field controls so users can discover and override these settings.
  </action>
  <verify>
Run: `python -c "import yaml; c = yaml.safe_load(open('config.example.yaml')); assert 'resolution' in c; assert c['resolution']['enabled'] is True; assert c['resolution']['max_iterations'] == 2; print('PASS')"`
  </verify>
  <done>config.example.yaml contains a resolution section with enabled=true and max_iterations=2, with comments explaining each field.</done>
</task>

</tasks>

<verification>
1. All 9 step names in _STEPS match what the orchestrator emits (sdtm_track_a, sdtm_track_b, adam_track_a, adam_track_b, stats_track_a, stats_track_b, simulator, stage_comparison, medical_writer).
2. PipelineDisplay satisfies the full ProgressCallback protocol including resolution methods:
   `python -c "from omni_agents.display.callbacks import ProgressCallback; from omni_agents.display.pipeline_display import PipelineDisplay; assert isinstance(PipelineDisplay(), ProgressCallback); print('PASS')"`
3. config.example.yaml parses cleanly and contains all expected sections.
4. Existing test suite still passes: `python -m pytest tests/ -x -q`
</verification>

<success_criteria>
- Zero pipeline steps silently dropped: all 9 orchestrator step names have matching entries in _STEPS
- Resolution callbacks implemented: on_resolution_start and on_resolution_complete present in PipelineDisplay
- Config documented: resolution section in config.example.yaml with enabled and max_iterations
- No regressions: all 88 existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-display-layer-update/02-01-SUMMARY.md`
</output>
